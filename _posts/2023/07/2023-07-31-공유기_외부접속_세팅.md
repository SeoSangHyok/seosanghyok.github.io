---
layout: post
title: 공유기 외부접속 세팅
subtitle: 공유기의 DDNS 기능과 포트 포워딩 기능을 이용해서 외부망에서도 접속 내 컴퓨터에 접속할 수 있도록 해보자
categories: network
tags: [network, 공유기] 
---

네트워크나 서버 프로그래밍, DB공부, 개인 파일서버나 원격접속등 외부에서 내 컴퓨터에 접근해야 할일은 상당히 많다. 만약 우리집에 있는 로컬컴퓨터에 원격 데스크탑이 가능하도록 세팅했다고 하자. 그리고 까패나 다른 곳에서 일이 생겨 내 컴퓨터에 원격으로 붙어야 할때 어떻게 하면 될까?

## 일단 그냥 한번 해보자 

원격 데스크탑 세팅이 가능한 사람이라면 CMD(명령프롬프트)창에서 **ipconfig** 명령을 이용해서 자신의 IP정도는 쉽게 확인 할 수 있을것이다. 만약 집이고 공유기를 이용해서 인터넷을 연결중이라면 노트북등 다른 컴퓨터에서 원격으로 붙는것도 손쉽게 가능할 것이다.

### 그런대 만약 다른곳에서 똑같이 한다면??

만약 까페의 인터넷 을 사용하거나 인터넷이 안되는 환경에서 휴대폰 테더링을 통해 인터넷을 하고 있는경우 위에서 한거처럼 똑같은 ip를 넣고 접속이 가능할까?? 당장 까페에 가서 테스트해보자. 굳이 까페에 가지 않더라도 노트북이 있다면 휴대폰 등으로 노트북을 테더링 연결 후 해보자. 

## 왜 안되는 걸까??

아마 대부분 집과 까페에 인터넷을 연결하는 상황은 아래와 같을것이다.

``` plantuml!
@startuml
cloud INTERNET
node "집" as Home {
component "모뎀" as H_modem
component "공유기" as H_NAT
rectangle "컴퓨터\n(192.168.0.51)" as H_Com
rectangle "노트북" as H_note
rectangle "휴대폰" as H_phone

H_modem -- H_NAT
H_NAT -- H_Com
H_NAT -- H_note
H_NAT -- H_phone
}

node "cafe" as Cafe {
component "공유기" as C_NAT
note left of C_NAT
    공유기와 모뎀 
    기능이 하나에 
    같이 있는 
    경우도 있다.
end note
rectangle "노트북1" as C_note1
rectangle "노트북2" as C_note2
rectangle "..." as C_etc

C_NAT -- C_note1
C_NAT -- C_note2
C_NAT -- C_etc
}

INTERNET -- H_modem
INTERNET -- C_NAT

@enduml
```

이것을 도식화 하면 아래와 같다.

``` plantuml!
@startuml
!include <office/Communications/sms_gateway>
!include <office/Communications/smtp_connector>
!include <office/Communications/voip_gateway>
!include <office/Devices/modem>
!include <office/Devices/workstation>
!include <office/Devices/cell_phone_generic>
!include <office/Devices/device_laptop>

nwdiag {
  network Internet {
    HomeRouter [address = "<b><color:#0000ff>119.158.200.145</color></b>", description = "<$voip_gateway>\n인터넷모뎀"]
    CafeRouter [address = "<b><color:#0000ff>187.245.131.112</color></b>", description = "<$modem>\n까패공유기\n(모뎀과 공유기가\n일체형인 경우도 있다.)"]
  }
  HomeRouter -- HomeNAT
  HomeNAT [address = "<b><color:#ff0000>192.168.0.1</color></b>", description = "<$modem>\n집공유기"]
  
  network Home {
    HomeNAT
    HomeCom1 [address = "<b><color:#ff0000>192.168.0.50</color></b>", description = "<$workstation>\n데스크탑"]
    HomeCom2 [address = "192.168.0.70", description = "<$device_laptop>\n노트북"]
    HomeCom3 [address = "192.168.0.78", description = "<$cell_phone_generic>\n휴대폰"]
  }

  network Cafe {
    CafeRouter [address = "<b><color:#ff0000>192.168.0.1</color></b>"]
    CafeCom1 [address = "192.168.0.30", description = "<$workstation>\n데스크탑"]
    CafeCom2 [address = "<b><color:#ff0000>192.168.0.50</color></b>", description = "<$device_laptop>\n노트북1"]
    CafeCom3 [address = "192.168.0.75", description = "<$device_laptop>\n노트북2"]
  }
  
  group {
    description = "집 네트워크"
    HomeRouter;
    HomeNAT;
    HomeCom1;
    HomeCom2;
    HomeCom3;
  }

  group {
    description = "까페 네트워크"
    CafeRouter;
    CafeCom1;
    CafeCom2;
    CafeCom3;
  }
}
@enduml
```

여기서 인터넷 망은 모뎀 혹은 공유기에 연결되며 PC나 휴대론은 공유기에 연결되서 인터넷에 연결된다. 여기서 집 모뎀과 카페 공유기는 각각 **카페 공유기 네트워크 망**, **집 공유기 네트워크 망** 으로 각각 독립된 네트워크다.(LAN 망이라고도 한다.) 

### 각각의 네트워크 망은 내부IP를 이용해서 통신한다.

위 그림에서 붉은색으로 표시된 IP는 집과 까페 네트워크에 중복해서 있는것을 볼 수 있다. 내부 내트워크 망에서서는 장비를 구분하기 위해 내부 IP주소를 사용하며 이 IP는 말그대로 내부 네트워크에서 사용되는 것이기 대문에 네트워크가 다르다면 중복가능하다. 즉 집과 까페에서 **192.168.0.50** ip 주소의 장비는 다른 장비다. 그렇기 때문에 집에서는 동작하는 원격이나 서버 접속이 다른곳에서 하면 안되는 것이다.

### 어?! 그럼 네이버에서 ip찾기한담에 그걸로 접속하면 되겠내요?

위에서 파란색으로 표시된 ip주소가 우리집 혹은 까페의 네트워크 IP주소이며 네이버에서 **내 ip확인** 등으로 확인할 수 있다. 그러면 "어?! 저주소로 접속하면 되는거 아냐??" 라고 생각할 수 있다. 하지만 위 도식을 보자. 푸른색 ip로 지정된 네트워크 밑에 컴퓨터 노트북 휴대폰등 여러장비가 연결되어 있다. 그럼 저 IP로 접속했을 때 어디로 접속해야 할까?? 모호해진다. 여기서 IP주소 이외에 포트(PORT) 라는 개념이 등장한다.

## PORT

위에서 IP주소로 네트워크에 접속한 장비 자체의 주소를 판단할 수 있다고 했다. 우리가 네트워크 장비에 접속한다는 것은 다른 의미로 **어떤 장비(IP)에 실행중인 어떤 프로그램**에 접속한다는 것을 의미한다. (원격도 하나의 프로그램이다.) 여기서 어떤 프로그램 을 구분할 수 있는 내용이 포트(PORT)다. 즉 어떤 장비(IP)의 어떤 프로그램(PORT) 에 접속 하는것. 그러면 위 도식은 아래와 같이 확장될 수 있다.

``` plantuml!
@startuml
!include <office/Communications/sms_gateway>
!include <office/Communications/smtp_connector>
!include <office/Communications/voip_gateway>
!include <office/Devices/modem>
!include <office/Devices/workstation>
!include <office/Devices/cell_phone_generic>
!include <office/Devices/device_laptop>

nwdiag {
  network Internet {
    HomeRouter [address = "<b><color:#0000ff>119.158.200.145</color></b>", description = "<$voip_gateway>\n인터넷모뎀"]
    CafeRouter [address = "<b><color:#0000ff>187.245.131.112</color></b>", description = "<$modem>\n까패공유기\n(모뎀과 공유기가\n일체형인 경우도 있다.)"]
  }
  HomeRouter -- HomeNAT
  HomeNAT [address = "<b><color:#ff0000>192.168.0.1</color></b>", description = "<$modem>\n집공유기"]
  
  network Home {
    HomeNAT
    HomeCom1 [address = "<b><color:#ff0000>192.168.0.50</color></b>", description = "<$workstation>\n데스크탑"]
    HomeCom2 [address = "192.168.0.70", description = "<$device_laptop>\n노트북"]
    HomeCom3 [address = "192.168.0.78", description = "<$cell_phone_generic>\n휴대폰"]
  }
  HomeCom1 -- remoteApp;
  HomeCom2 -- servApp;
  remoteApp [address = "192.168.0.78:**9764**", description = "원격데스크탑"];
  servApp [address = "192.168.0.78:**9987**", description = "서버프로그램"];

  network Cafe {
    CafeRouter [address = "<b><color:#ff0000>192.168.0.1</color></b>"]
    CafeCom1 [address = "192.168.0.30", description = "<$workstation>\n데스크탑"]
    CafeCom2 [address = "<b><color:#ff0000>192.168.0.50</color></b>", description = "<$device_laptop>\n노트북1"]
    CafeCom3 [address = "192.168.0.75", description = "<$device_laptop>\n노트북2"]
  }
  
  group {
    description = "집 네트워크"
    HomeRouter;
    HomeNAT;
    HomeCom1;
    HomeCom2;
    HomeCom3;
  }

  group {
    description = "까페 네트워크"
    CafeRouter;
    CafeCom1;
    CafeCom2;
    CafeCom3;
  }
}
@enduml
```

### 먼가 외부에서 접속할 수 있는 방법이 보인다...




**인터넷과 직접 연결된 장비** 는 공유기/모뎀 이다. 해당 장비에서 내부 ip를 통해 인터넷으로 연결되기 때문에 내 ip확인 으로 나오는 ip는 공유기 나 모뎀의 ip이다. 즉 사용하고 있는 컴퓨터의 ip가 아니기 때문에 해당 ip로는 접속할 수 없다.

### 그리고 모뎀/공유기 를 통해 들어오는 ip는 계속해서 변경된다...

일반 가정이나 그에 준하는 장소에서 인터넷을 연결하는 경우 장비로 들어오는 ip는 고정되지 않고 일정 기간이 지나면 계속해서 변경된다.. 공용 ip주소는 한정적이기 때문에 인터넷 서비스 회사(ISP라고 한다.) 에선 낭비되는 ip가 없도록  ip를 대여하는 기간을 두고 그 기간이 지나면 계속해서 다른 ip를 재할당 하는 식으로 IP를 관리한다. 그렇기 때문에 오늘 네이버에서 확인한 ip가 내일도 같을거라는 보장은 없다.


하지만 까페에서 인터넷을 연결하면 까페의 인터넷망을.. 테더링을 이용하게 되면 사용하고 있는 통신사의 네트워크 망을 사용하게 된다. 같은 망에서 ipconfig를 이용해서 ip를 확인하게 되면 사용하고 있는 공유기 네트워크 에서의 컴퓨터 주소 즉 내부ip가 나온다.

위 그림처럼 네트워크 망이 다르다면 내부 ip주소는 서로 같을 수 있기때문에 다른 네트워크 환경에선 내부 ip주소만으로는 내 컴퓨터를 특정할 수 없다.

